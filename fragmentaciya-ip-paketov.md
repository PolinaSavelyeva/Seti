# Фрагментация IP пакетов

## Для чего нужна фрагментация

Если роутер соединяет несколько различных канальных сред, имеющих различные MTU (maximum transmission unit означает максимальный размер полезного блока данных одного пакета, который может быть передан протоколом без фрагментации). И при этом пакет передаются от интерфейса с большим MTU в интерфейс с меньшим, необходимо совершить фрагментацию пакета, иначе он не влезет.



## Как посчитать количество пакетов после фрагментации

Олифер описывает алгоритм так: если максимальный размер 1000, а пакет размером 1400, то происходит фрагментация на 2 пакета по 700. При таком подходе пакеты с меньшей вероятностью будут требовать дополнительной фрагментации далее по пути.

В реальном оборудовании пакет делят на n частей максимально возможного размера (1000) и что останется.



## Как происходит фрагментация

С помощью полей ident, flags, fragment offset в IP пакете.



## Cборка

Сборка производится только на получателе, не на пути, чтобы ускорить процесс и не нагружать оборудование. Таймер ожидания фрагментов также заводится на получателе и буфер заводит также только получатель.

Кроме случаев передачи пакетов через файервол. Файерволу необходимо получить полную информацию о пакете, и для этого он собирает фрагменты обратно в _виртуальный_  (это значит, что после анализа пакета файерволом, он отправляет дальше не собранный пакет, а пришедшие фрагменты) пакет.



## Меры разгрузки роутеров от фрагментации

* Изначательно уведомить отправителя о том, что по пути следования есть MTU меньше.
* Поставить флаг DF (don't fragment).
